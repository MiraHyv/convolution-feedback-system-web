(()=>{"use strict";const t=512;function n(t){console.log(t)}class i{constructor(){this.fb=null,this.uniformPaikka=null;const t=this.haeKonteksti();null!=t&&(this.luoShader("#version 300 es\nout vec2 uv;\n\nconst vec4 kulmat[4] = vec4[4](\n    vec4(-1, -1, 0, 1),\n    vec4( 1, -1, 0, 1),\n    vec4(-1,  1, 0, 1),\n    vec4( 1,  1, 0, 1)\n);\n\nconst vec2 kulmat_uv[4] = vec2[4](\n    vec2(0, 0),\n    vec2(1, 0),\n    vec2(0, 1),\n    vec2(1, 1)\n);\n\nvoid main() {\n    vec4 t = vec4(1, 1, 1, 1);\n    gl_Position = t * kulmat[gl_VertexID];\n    uv = kulmat_uv[gl_VertexID];\n}\n","#version 300 es\nprecision highp float;\nin vec2 uv;\nuniform sampler2D tekstuuri0;\nuniform float[49] uData;\nout vec4 color;\n\nvoid main(void) {\n    color = texture(tekstuuri0, uv);\n}\n"),this.fb=t.createFramebuffer())}haeKonteksti(){return document.querySelector("#piirtoalue").getContext("webgl2")}kaannaShader(t,i){const o=this.haeKonteksti(),e=o.createShader(t);return o.shaderSource(e,i),o.compileShader(e),o.getShaderParameter(e,o.COMPILE_STATUS)?e:(t==o.VERTEX_SHADER?n("Vertex shaderin kääntäminen epäonnistui:\n"):t==o.FRAGMENT_SHADER&&n("Fragment shaderin kääntäminen epäonnistui:\n"),n(o.getShaderInfoLog(e)),o.deleteShader(e),null)}luoShader(t,i){const o=this.haeKonteksti(),e=this.kaannaShader(o.VERTEX_SHADER,t);if(null==e)return;const a=this.kaannaShader(o.FRAGMENT_SHADER,i);if(null==a)return;const r=o.createProgram();return o.attachShader(r,e),o.attachShader(r,a),o.linkProgram(r),o.getProgramParameter(r,o.LINK_STATUS)?(this.kaytaShaderia(r),this.uniformPaikka=o.getUniformLocation(r,"uData"),r):(n("Shaderin linkitys epäonnistui:\n"),n(o.getProgramInfoLog(r)),null)}kaytaShaderia(t){this.haeKonteksti().useProgram(t)}piirra(){const t=this.haeKonteksti();t.drawArrays(t.TRIANGLE_STRIP,0,4)}generoiKuva(){const n=this.haeKonteksti(),i=n.createTexture();n.bindTexture(n.TEXTURE_2D,i);const o=n.RGBA,e=n.RGBA,a=n.UNSIGNED_BYTE,r=new Uint8Array(1048576);let s=0;for(let n=0;n<t;n++)for(let n=0;n<t;n++){const t=n/512;let i=Math.pow(t,.5),o=t,e=.3+Math.pow(.7*t,1.5);const a=20,u=20;Math.random()*a<1&&(i=1),Math.random()*a<1&&(o=1),Math.random()*a<1&&(e=1),Math.random()*u<1&&(i=0),Math.random()*u<1&&(o=0),Math.random()*u<1&&(e=0),r[s]=Math.floor(256*i),r[s+1]=Math.floor(256*o),r[s+2]=Math.floor(256*e),r[s+3]=255,s+=4}return n.texImage2D(n.TEXTURE_2D,0,o,512,512,0,e,a,r),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),i}piirraKuva(t){const n=this.haeKonteksti();n.bindFramebuffer(n.FRAMEBUFFER,null),n.bindTexture(n.TEXTURE_2D,t),n.viewport(0,0,2048,2048),this.piirra()}piirraKuvaan(n,i){const o=this.haeKonteksti();o.bindFramebuffer(o.FRAMEBUFFER,this.fb),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,i,0),o.bindTexture(o.TEXTURE_2D,n),o.viewport(0,0,t,t),this.piirra()}asetaUniform(t){this.haeKonteksti().uniform1fv(this.uniformPaikka,t)}}const o="#version 300 es\nout vec2 uv;\n\nconst vec4 kulmat[4] = vec4[4](\n    vec4(-1, -1, 0, 1),\n    vec4( 1, -1, 0, 1),\n    vec4(-1,  1, 0, 1),\n    vec4( 1,  1, 0, 1)\n);\n\nconst vec2 kulmat_uv[4] = vec2[4](\n    vec2(0, 0),\n    vec2(1, 0),\n    vec2(0, 1),\n    vec2(1, 1)\n);\n\nvoid main() {\n    vec4 t = vec4(-1, -1, 1, 1);\n    gl_Position = t * kulmat[gl_VertexID];\n    uv = kulmat_uv[gl_VertexID];\n}\n",e=new class{constructor(){this.tx_front=null,this.tx_back=null,this.convolutionMatrix=new Float32Array(49),this.shader_default=null,this.shader_convolution=null,this.piirto=null,this.kaanto=1,this.setup()}setup(){this.piirto=new i,this.tx_front=this.piirto.generoiKuva(),this.tx_back=this.piirto.generoiKuva(),this.shader_default=this.piirto.luoShader(o,"#version 300 es\nprecision highp float;\nin vec2 uv;\nuniform sampler2D tekstuuri0;\nout vec4 color;\n\nvoid main(void) {\n    color = texture(tekstuuri0, uv);\n}\n"),this.shader_convolution=this.piirto.luoShader(o,"#version 300 es\nprecision highp float;\nuniform float[49] uData;\nin vec2 uv;\nuniform sampler2D tekstuuri0;\nout vec4 color;\n\nvoid main(void) {\n    float value = 0.0;\n    vec4 color0 = texture(tekstuuri0, uv);\n    for(int i=0; i<49; i++) {\n        int y = i / 7;\n        int x = i % 7;\n        float yf = float(y);\n        float xf = float(x);\n        vec2 d = vec2( (xf-3.0)/(1024.0), (yf-3.0)/(1024.0));\n        value += texture(tekstuuri0, uv + d).r * uData[i];\n    }\n    color = mix(color0, vec4(value, value, value, 1), 0.5);\n}\n"),this.randomizeConvolution(),this.piirto.asetaUniform(this.convolutionMatrix)}randomizeConvolution(){for(let t of this.convolutionMatrix){for(let t=0;t<this.convolutionMatrix.length;t++)this.convolutionMatrix[t]=4*Math.random()-2;this.normalizeConvolution()}console.log(this.convolutionMatrix)}normalizeConvolution(){let t=0;for(const n of this.convolutionMatrix)t+=n;let n=1/t;for(let t=0;t<this.convolutionMatrix.length;t++)this.convolutionMatrix[t]*=n}update(){this.randomChangeConvolution(),this.piirto.kaytaShaderia(this.shader_convolution),this.piirto.asetaUniform(this.convolutionMatrix),1==this.kaanto?(this.piirto.piirraKuvaan(this.tx_back,this.tx_front),this.kaanto=0):(this.piirto.piirraKuvaan(this.tx_front,this.tx_back),this.kaanto=1),this.piirto.kaytaShaderia(this.shader_default),this.piirto.piirraKuva(this.tx_front)}randomChangeConvolution(){const t=Math.floor(4*Math.random())+1;for(let n=0;n<t;n++){const t=Math.floor(49*Math.random());this.convolutionMatrix[t]+=.05*Math.random()-.025,this.convolutionMatrix[t]<-1&&(this.convolutionMatrix[t]=-1),this.convolutionMatrix[t]>1&&(this.convolutionMatrix[t]=1)}this.normalizeConvolution()}};!function t(){e.update(),requestAnimationFrame(t)}()})();